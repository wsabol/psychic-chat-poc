================================================================================
ORACLE.JS QUICK NAVIGATION GUIDE
================================================================================

File: worker/modules/oracle.js
Purpose: Core oracle engine - user data loading, context building, API calls

Quick Links to Sections:
================================================================================

SECTION 1: OPENAI CLIENT FACTORY (line ~24)
────────────────────────────────────────────────────────────────────────────
Purpose: Singleton OpenAI client instance
Functions:
  • getOpenAIClient() - Returns reusable OpenAI client

Usage: Called internally by callOracle()

When to touch:
  - Changing OpenAI model (update in callOracle)
  - Adjusting API parameters (temperature, max_tokens, etc)
  - Adding streaming support


SECTION 2: DATABASE QUERIES (line ~31)
────────────────────────────────────────────────────────────────────────────
Purpose: Load user data from encrypted database

Functions:
  ✓ fetchUserPersonalInfo(userId)
    Returns: { first_name, last_name, birth_date, birth_time, birth_city, 
               birth_province, birth_country, birth_timezone, sex, address_preference }
    Used: Chat messages, personalization, context building

  ✓ fetchUserAstrology(userId)
    Returns: { zodiac_sign, astrology_data: { sun_sign, sun_degree, moon_sign, 
               moon_degree, rising_sign, rising_degree, timezone, latitude, longitude } }
    Used: Astrology context, cosmic weather, horoscopes

  ✓ isTemporaryUser(userId)
    Returns: true/false
    Used: Prompt selection (trial vs established), response generation

  ✓ fetchUserLanguagePreference(userId)
    Returns: 'en-US' | 'es-ES' | 'fr-FR' | etc
    Used: UI language, message translation

  ✓ fetchUserOracleLanguagePreference(userId)
    Returns: 'en-US' | 'es-ES' | 'fr-FR' | etc
    Used: Oracle response language (separate from UI)

All use: pgp_sym_decrypt() for encrypted data + ENCRYPTION_KEY from .env

When to touch:
  - Adding new user data fields
  - Changing encryption method
  - Optimizing database queries
  - Adding new language preferences


SECTION 3: CONTEXT BUILDING (line ~131)
────────────────────────────────────────────────────────────────────────────
Purpose: Format user data into system prompt instructions

Functions:
  ✓ buildPersonalInfoContext(userInfo)
    Creates: USER PROFILE INFORMATION block with name, birth date/time, location
    Example: "- Name: Alice Smith\n- Date of Birth: 1990-05-15\n..."

  ✓ buildAstrologyContext(astrologyInfo, userInfo)
    Creates: ASTROLOGICAL PROFILE block with sun/moon/rising signs + coordinates
    Example: "- Sun Sign (Core Identity): Taurus (25°)\n..."

  ✓ buildLanguageInstruction(language)
    Creates: LANGUAGE REQUIREMENT block for oracle
    Only used if language !== 'en-US'

  ✓ getOracleSystemPrompt(isTemporaryUser, language)
    Creates: COMPLETE system prompt including:
      - Base instructions (100+ lines: tarot rules, crystal guidance, etc)
      - Account type section (trial vs established)
      - Language requirement (if not English)
    
    Called by: oracleProcessor.js
    Result: Used as 'system' role message in OpenAI API

When to touch:
  - Updating oracle personality/instructions
  - Changing tarot reversal rules
  - Adjusting response format (HTML structure)
  - Modifying crystal/aromatherapy guidance
  - Adding new sections to readings
  - Changing trial vs established user instructions


SECTION 4: ORACLE API INTERACTIONS (line ~393)
────────────────────────────────────────────────────────────────────────────
Purpose: Direct OpenAI API calls

Functions:
  ✓ callOracle(systemPrompt, messageHistory, userMessage, generateBrief)
    
    Input:
      • systemPrompt: Full system prompt from getOracleSystemPrompt()
      • messageHistory: Array of {role, content} - in ASC order (oldest first)
      • userMessage: Current user's message
      • generateBrief: Boolean (default true) - generate summary too?
    
    Process:
      1. Reverses history to DESC order (most recent context first)
      2. Calls OpenAI GPT-4o-mini with full prompt
      3. If generateBrief=true:
         - Takes full response
         - Calls OpenAI again with brief summarization prompt
         - Returns both versions
      4. If generateBrief=false:
         - Returns only full response
    
    Output: { full: string, brief: string | null }
    
    Error: Throws if API fails

When to touch:
  - Changing OpenAI model (gpt-4o-mini → gpt-4-turbo, etc)
  - Adding/removing brief generation
  - Changing API parameters (temperature, top_p, frequency_penalty)
  - Adjusting brief summarization prompt
  - Adding retry logic for API failures


SECTION 5: UTILITIES (line ~470)
────────────────────────────────────────────────────────────────────────────
Purpose: Helper functions

Functions:
  ✓ getUserGreeting(userInfo, userId, isTemporaryUser)
    Returns: Personalized greeting name
      - Temp/trial users: "Seaker" (default)
      - Established users: address_preference or first_name
      - Fallback: "Friend"
    Used: Horoscope openings, personalized messages

  ✓ extractScentDataFromResponse(responseText)
    Parses: Oracle's HTML response
    Extracts: <h3>Aromatherapy Support</h3> section
    Returns: { hasScentGuidance: bool, content: string }
    Used: Analytics, feature detection, future logging

When to touch:
  - Changing default greeting
  - Adding new aromatherapy detection
  - Adding other response parsing


================================================================================
TYPICAL USAGE FLOWS
================================================================================

SCENARIO 1: User sends chat message
──────────────────────────────────────
1. api/routes/chat.js stores user message
2. Worker gets job from queue
3. chat-handler.js → processOracleRequest()
4. oracle.js functions called:
   ✓ fetchUserPersonalInfo() - get name, location
   ✓ fetchUserAstrology() - get birth chart
   ✓ isTemporaryUser() - check account type
   ✓ fetchUserLanguagePreference() - UI language
   ✓ fetchUserOracleLanguagePreference() - oracle language
   ✓ buildPersonalInfoContext() - format user data
   ✓ buildAstrologyContext() - format astrology
   ✓ getOracleSystemPrompt() - build full prompt
   ✓ callOracle() - GET RESPONSE
5. messages.js stores assistant response

SCENARIO 2: User requests horoscope
───────────────────────────────────
1. horoscope-handler.js gets user data
2. Calls oracle.js functions:
   ✓ fetchUserAstrology() - get sun sign
   ✓ isTemporaryUser() - adjust length
   ✓ getOracleSystemPrompt() - horoscope-specific prompt
   ✓ callOracle() - generate reading
3. Result stored in messages table

SCENARIO 3: Check if user is on trial
─────────────────────────────────────
1. isTemporaryUser(userId)
   ✓ Fetches email from encrypted db
   ✓ Checks if email starts with 'temp_'
   ✓ Returns true/false
2. Used in chat-handler.js to adjust prompts


================================================================================
DEBUGGING
================================================================================

Q: Oracle responses not appearing?
A: Check:
   • callOracle() returns data
   • storeMessage() in oracleProcessor succeeds
   • ENCRYPTION_KEY set in .env

Q: Context not personalized?
A: Check:
   • fetchUserPersonalInfo() returns data
   • buildPersonalInfoContext() formats correctly
   • getOracleSystemPrompt() includes context

Q: Wrong language in responses?
A: Check:
   • fetchUserOracleLanguagePreference() returns correct language
   • buildLanguageInstruction() called with that language
   • System prompt includes language requirement

Q: Temporary users seeing wrong prompt?
A: Check:
   • isTemporaryUser() returns true
   • getOracleSystemPrompt(true, lang) called
   • User email starts with 'temp_'

Q: API errors in console?
A: Check:
   • OPENAI_API_KEY set in .env
   • OpenAI account has credits
   • Check callOracle() catch block


================================================================================
MAINTENANCE CHECKLIST
================================================================================

Weekly:
  □ Check Oracle API costs/usage
  □ Review error logs for API failures
  □ Test trial vs established user prompts

Monthly:
  □ Review oracle response quality
  □ Check database query performance
  □ Test language translations
  □ Update system prompt if needed

Before deploying changes:
  □ Test personal info context building
  □ Test astrology context building
  □ Test with different languages
  □ Test with trial and established users
  □ Check API response formatting

When updating system prompt:
  □ Update only getOracleSystemPrompt() basePrompt
  □ Test tarot reversal rates
  □ Test HTML formatting in responses
  □ Test with established user instructions
  □ Test with trial user instructions
  □ Re-check response length


================================================================================
